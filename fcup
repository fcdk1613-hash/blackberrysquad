# bot.py
import asyncio
import logging
import sqlite3
from datetime import datetime, timedelta

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import CommandStart
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

# === –í—Å—Ç–∞–≤—å —Å–≤–æ–π —Ç–æ–∫–µ–Ω —Å—é–¥–∞ ===
API_TOKEN = "8392821328:AAHHINFxwpSZKGRcv0vQXogGc-pnXcAZspI"

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# === DB: –∏—Å–ø–æ–ª—å–∑—É–µ–º check_same_thread=False —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º –≤ asyncio handlers ===
conn = sqlite3.connect("tournament.db", check_same_thread=False)
cursor = conn.cursor()

# === –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã ===
cursor.execute("""
CREATE TABLE IF NOT EXISTS commanders (
    user_id INTEGER PRIMARY KEY,
    phone TEXT,
    team_name TEXT
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS judges (
    user_id INTEGER PRIMARY KEY,
    phone TEXT,
    name TEXT
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS matches (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    team1 TEXT,
    team2 TEXT,
    datetime TEXT,
    result TEXT,
    judge_id INTEGER
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS roles (
    user_id INTEGER PRIMARY KEY,
    role TEXT
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS temp_schedule (
    user_id INTEGER PRIMARY KEY,
    datetime TEXT
)
""")
conn.commit()

# === Keyboards ===
role_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–Ø - –∫–æ–º–∞–Ω–¥–∏—Ä")],
        [KeyboardButton(text="–Ø - —Å—É–¥—å—è")]
    ],
    resize_keyboard=True
)

contact_kb = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä", request_contact=True)]],
    resize_keyboard=True
)

commander_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç—á")],
        [KeyboardButton(text="–ú–æ–∏ –º–∞—Ç—á–∏")]
    ],
    resize_keyboard=True
)

judge_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞")],
        [KeyboardButton(text="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è")]
    ],
    resize_keyboard=True
)

# === Bot & Dispatcher ===
bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher()

# –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è / –≤–Ω–µ—Å–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
user_state = {}  # user_id -> dict

# --------------------------
# /start –∏ –≤—ã–±–æ—Ä —Ä–æ–ª–∏
# --------------------------
@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:", reply_markup=role_keyboard)


@dp.message(F.text == "–Ø - –∫–æ–º–∞–Ω–¥–∏—Ä")
async def choose_commander(message: types.Message):
    user_id = message.from_user.id
    cursor.execute("INSERT OR REPLACE INTO roles (user_id, role) VALUES (?, ?)", (user_id, "commander"))
    conn.commit()
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:", reply_markup=contact_kb)


@dp.message(F.text == "–Ø - —Å—É–¥—å—è")
async def choose_judge(message: types.Message):
    user_id = message.from_user.id
    cursor.execute("INSERT OR REPLACE INTO roles (user_id, role) VALUES (?, ?)", (user_id, "judge"))
    conn.commit()
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:", reply_markup=contact_kb)


# --------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
# --------------------------
@dp.message(F.content_type == types.ContentType.CONTACT)
async def process_contact(message: types.Message):
    contact = message.contact
    user_id = message.from_user.id
    phone = contact.phone_number

    role_row = cursor.execute("SELECT role FROM roles WHERE user_id = ?", (user_id,)).fetchone()
    if not role_row:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å (–∫–æ–º–∞–Ω–¥–∏—Ä –∏–ª–∏ —Å—É–¥—å—è).", reply_markup=role_keyboard)
        return

    role = role_row[0]
    if role == "commander":
        # —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –∫–æ–º–∞–Ω–¥–∏—Äa, team_name –ø–æ–∫–∞ NULL
        cursor.execute("INSERT OR REPLACE INTO commanders (user_id, phone, team_name) VALUES (?, ?, ?)",
                       (user_id, phone, None))
        conn.commit()
        await message.answer("–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã (—Ç–µ–∫—Å—Ç–æ–º).",
                             reply_markup=ReplyKeyboardRemove())
    else:  # judge
        cursor.execute("INSERT OR REPLACE INTO judges (user_id, phone, name) VALUES (?, ?, ?)",
                       (user_id, phone, message.from_user.full_name))
        conn.commit()
        await message.answer("‚úÖ –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ —Å—É–¥—å—è.", reply_markup=judge_menu)


# --------------------------
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞)
# --------------------------
@dp.message(F.text & ~F.via_bot & ~F.contact)
async def save_team_name_or_ignore(message: types.Message):
    user_id = message.from_user.id
    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (–µ—Å—Ç—å –∑–∞–ø–∏—Å—å –≤ commanders, team_name IS NULL)
    row = cursor.execute("SELECT team_name FROM commanders WHERE user_id = ?",
                         (user_id,)).fetchone()
    if row and row[0] is None:
        team_name = message.text.strip()
        if not team_name:
            await message.answer("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            return
        cursor.execute("UPDATE commanders SET team_name = ? WHERE user_id = ?", (team_name, user_id))
        conn.commit()
        await message.answer(f"‚úÖ –ö–æ–º–∞–Ω–¥–∞ <b>{team_name}</b> –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!", reply_markup=commander_menu)
        return

    # –∏–Ω–∞—á–µ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º, –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–∞–ª—å—à–µ (—Å–ª–µ–¥—É—é—â–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Å—Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —Ç–µ–∫—Å—Ç—É)
    # –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–º
    return


# --------------------------
# –ö–æ–º–∞–Ω–¥–∏—Ä: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞
# --------------------------
@dp.message(F.text == "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç—á")
async def plan_match_start(message: types.Message):
    user_id = message.from_user.id
    # –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∫–æ–º–∞–Ω–¥–∏—Ä —Å –∑–∞–¥–∞–Ω–Ω—ã–º team_name
    row = cursor.execute("SELECT team_name FROM commanders WHERE user_id = ?", (user_id,)).fetchone()
    if not row or not row[0]:
        await message.answer("–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∏—Ä –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã. –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.")
        return

    # –≥–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –¥–∞—Ç: –æ—Å—Ç–∞—Ç–æ–∫ –Ω–µ–¥–µ–ª–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
    today = datetime.now().date()
    days_to_end = 6 - today.weekday() if today.weekday() <= 6 else 0
    dates = [today + timedelta(days=i) for i in range(days_to_end + 1)]
    kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text=d.isoformat())] for d in dates], resize_keyboard=True)

    # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
    user_state[user_id] = {"action": "scheduling"}
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–µ–¥–µ–ª–∏):", reply_markup=kb)


@dp.message(F.text.regexp(r"^\d{4}-\d{2}-\d{2}$"))
async def plan_match_choose_date(message: types.Message):
    user_id = message.from_user.id
    state = user_state.get(user_id)
    if not state or state.get("action") != "scheduling":
        return  # –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º

    date_str = message.text  # YYYY-MM-DD
    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    state["date"] = date_str

    # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–∞ 19:00..22:00 —à–∞–≥ 30 –º–∏–Ω—É—Ç
    times = []
    hh = 19
    mm = 0
    while True:
        times.append(f"{hh:02d}:{mm:02d}")
        # —à–∞–≥
        mm += 30
        if mm == 60:
            hh += 1
            mm = 0
        if hh > 22 or (hh == 22 and mm > 0):
            break

    kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text=t)] for t in times], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è (—à–∞–≥ 30 –º–∏–Ω—É—Ç, 19:00‚Äì22:00):", reply_markup=kb)


@dp.message(F.text.regexp(r"^\d{2}:\d{2}$"))
async def plan_match_choose_time(message: types.Message):
    user_id = message.from_user.id
    state = user_state.get(user_id)
    if not state or state.get("action") != "scheduling" or "date" not in state:
        return

    date_str = state["date"]            # YYYY-MM-DD
    time_str = message.text             # HH:MM
    dt_str = f"{date_str} {time_str}"   # store as "YYYY-MM-DD HH:MM"

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è team_name
    row = cursor.execute("SELECT team_name FROM commanders WHERE user_id = ?", (user_id,)).fetchone()
    if not row or not row[0]:
        await message.answer("–û—à–∏–±–∫–∞: —É –≤–∞—Å –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        user_state.pop(user_id, None)
        return
    team_name = row[0]

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ temp_schedule –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è
    opponent = cursor.execute(
        "SELECT user_id FROM temp_schedule WHERE datetime = ? AND user_id != ?",
        (dt_str, user_id)
    ).fetchone()

    if opponent:
        opponent_id = opponent[0]
        # –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —É –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞
        opp_team_row = cursor.execute("SELECT team_name FROM commanders WHERE user_id = ?", (opponent_id,)).fetchone()
        if not opp_team_row or not opp_team_row[0]:
            # —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞ –∏ —Å—Ç–∞–≤–∏–º –Ω–∞—à—É –≤ temp, –Ω–æ –ª—É—á—à–µ –æ–ø–æ–≤–µ—Å—Ç–∏—Ç—å
            cursor.execute("DELETE FROM temp_schedule WHERE user_id = ?", (opponent_id,))
            conn.commit()
            # –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –≤ temp (—á—Ç–æ–±—ã –∂–¥–∞—Ç—å)
            cursor.execute("INSERT OR REPLACE INTO temp_schedule (user_id, datetime) VALUES (?, ?)", (user_id, dt_str))
            conn.commit()
            await message.answer("–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±—Ä–∞–ª —Å–ª–æ—Ç, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã. –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–∂–∏–¥–∞–Ω–∏–µ.", reply_markup=commander_menu)
            user_state.pop(user_id, None)
            return

        opponent_team = opp_team_row[0]

        # –°–æ–∑–¥–∞—ë–º –º–∞—Ç—á —Å –¥–≤—É–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏
        cursor.execute("INSERT INTO matches (team1, team2, datetime, result, judge_id) VALUES (?, ?, ?, ?, ?)",
                       (team_name, opponent_team, dt_str, None, None))
        conn.commit()

        # –£–¥–∞–ª—è–µ–º temp_schedule –∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ (–¥–ª—è –æ–±–æ–∏—Ö)
        cursor.execute("DELETE FROM temp_schedule WHERE datetime = ?", (dt_str,))
        conn.commit()

        # –æ–ø–æ–≤–µ—â–∞–µ–º –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
        await bot.send_message(user_id, f"‚úÖ –ú–∞—Ç—á –Ω–∞–∑–Ω–∞—á–µ–Ω: {team_name} vs {opponent_team} –≤ {dt_str}", reply_markup=commander_menu)
        await bot.send_message(opponent_id, f"‚úÖ –ú–∞—Ç—á –Ω–∞–∑–Ω–∞—á–µ–Ω: {opponent_team} vs {team_name} –≤ {dt_str}", reply_markup=commander_menu)
    else:
        # –Ω–µ—Ç —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ temp_schedule –∏ –≥–æ–≤–æ—Ä–∏–º –∂–¥–∞—Ç—å
        cursor.execute("INSERT OR REPLACE INTO temp_schedule (user_id, datetime) VALUES (?, ?)", (user_id, dt_str))
        conn.commit()
        await message.answer(f"–°–ª–æ—Ç {dt_str} –≤—ã–±—Ä–∞–Ω. –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...", reply_markup=commander_menu)

    # –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    user_state.pop(user_id, None)


# --------------------------
# –ö–æ–º–∞–Ω–¥–∏—Ä: –ú–æ–∏ –º–∞—Ç—á–∏
# --------------------------
@dp.message(F.text == "–ú–æ–∏ –º–∞—Ç—á–∏")
async def my_matches(message: types.Message):
    user_id = message.from_user.id
    row = cursor.execute("SELECT team_name FROM commanders WHERE user_id = ?", (user_id,)).fetchone()
    if not row or not row[0]:
        await message.answer("–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∏—Ä –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.")
        return
    team_name = row[0]

    rows = cursor.execute("SELECT team1, team2, datetime, result FROM matches WHERE team1 = ? OR team2 = ?",
                          (team_name, team_name)).fetchall()
    if not rows:
        await message.answer("–£ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç—á–µ–π.")
        return

    text = f"–ú–∞—Ç—á–∏ –∫–æ–º–∞–Ω–¥—ã {team_name}:\n\n"
    for r in rows:
        opp = r[1] if r[0] == team_name else r[0]
        dt_display = r[2]
        result = r[3] or "–µ—â—ë –Ω–µ —Å—ã–≥—Ä–∞–Ω"
        text += f"{dt_display} ‚Äî vs {opp} ‚Äî {result}\n"
    await message.answer(text)


# --------------------------
# –°—É–¥—å—è: –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# --------------------------
@dp.message(F.text == "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞")
async def judge_list_matches(message: types.Message):
    rows = cursor.execute("SELECT id, team1, team2, datetime FROM matches WHERE result IS NULL AND team2 IS NOT NULL").fetchall()
    if not rows:
        await message.answer("–ù–µ—Ç –º–∞—Ç—á–µ–π –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è.", reply_markup=judge_menu)
        return

    kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text=f"{r[0]}: {r[1]} vs {r[2]} ({r[3]})")] for r in rows],
                             resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:", reply_markup=kb)


@dp.message(F.text.regexp(r"^\d+:"))
async def judge_choose_match(message: types.Message):
    # —Ñ–æ—Ä–º–∞—Ç –∫–Ω–æ–ø–∫–∏: "ID: team1 vs team2 (datetime)"
    match_id = int(message.text.split(":")[0])
    user_state[message.from_user.id] = {"action": "enter_result", "match_id": match_id}
    await message.answer("–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä., 'TeamA 2:1 TeamB' –∏–ª–∏ '2:1')")


@dp.message(F.text & ~F.via_bot & ~F.contact)
async def judge_enter_result(message: types.Message):
    state = user_state.get(message.from_user.id)
    if not state or state.get("action") != "enter_result":
        return  # –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

    match_id = state["match_id"]
    result_text = message.text.strip()
    cursor.execute("UPDATE matches SET result = ?, judge_id = ? WHERE id = ?",
                   (result_text, message.from_user.id, match_id))
    conn.commit()

    await message.answer("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.", reply_markup=judge_menu)
    user_state.pop(message.from_user.id, None)


# --------------------------
# –°—É–¥—å—è: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è
# --------------------------
@dp.message(F.text == "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è")
async def judge_results_today(message: types.Message):
    today_str = datetime.now().date().isoformat()
    rows = cursor.execute("SELECT team1, team2, datetime, result FROM matches WHERE date(datetime) = ? AND result IS NOT NULL",
                          (today_str,)).fetchall()
    if not rows:
        await message.answer("–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ –±—ã–ª–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π.", reply_markup=judge_menu)
        return

    text = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è:\n\n"
    for r in rows:
        text += f"{r[2]} ‚Äî {r[0]} vs {r[1]} ‚Äî {r[3]}\n"
    await message.answer(text, reply_markup=judge_menu)


# --------------------------
# –û—Ç–ª–∞–¥–æ—á–Ω—ã–π (fallback) ‚Äî –Ω–µ –º–µ—à–∞–µ–º —Ä–∞–±–æ—á–∏–º –∫–Ω–æ–ø–∫–∞–º
# --------------------------
@dp.message(F.text)
async def fallback_debug(message: types.Message):
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤—ã—à–µ).
    known = {
        "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç—á", "–ú–æ–∏ –º–∞—Ç—á–∏",
        "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è",
        "–Ø - –∫–æ–º–∞–Ω–¥–∏—Ä", "–Ø - —Å—É–¥—å—è", "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä"
    }
    if message.text not in known:
        logger.info("üì© –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: %s (from %s)", message.text, message.from_user.id)


# --------------------------
# –ó–∞–ø—É—Å–∫
# --------------------------
async def main():
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞, —É–¥–∞–ª—è—é webhooks (–µ—Å–ª–∏ –±—ã–ª–∏)")
    await bot.delete_webhook(drop_pending_updates=True)
    logger.info("Start polling")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
